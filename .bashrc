#!/bin/bash
# ~/.bashrc: Выполняется для не-логин интерактивных оболочек bash.

# =============================================================================
#  Раздел 1: Продвинутая обработка SSH и начальные проверки
# =============================================================================

# Эта строка — ключевая часть механизма для унификации окружения через sshb.
# Она корректно использует "$SHELL", потому что функция sshb на удаленной машине
# предварительно устанавливает SHELL=~/.bash-ssh (или на этот самый файл).
# Когда tmux/screen запускают новую оболочку, они исполняют этот файл как скрипт,
# и эта команда перезапускает bash, используя сам файл в качестве конфигурации.
[ -n "$SSH_TTY" ] && [ "${BASH_SOURCE[0]}" == "${0}" ] && exec bash --rcfile "$SHELL" "$@"

# Если это не интерактивная оболочка (например, скрипт), ничего не делать.
[ -z "$PS1" ] && return

# =============================================================================
#  Раздел 2: Загрузка конфигурационных файлов
# =============================================================================

# Загрузка переменных окружения и настроек
if [ -f ~/.bash_export ]; then
   . ~/.bash_export
fi

# Загрузка псевдонимов (aliases)
if [ -f ~/.bash_aliases ]; then
   . ~/.bash_aliases
fi

# Загрузка функций
if [ -f ~/.bash_functions ]; then
   . ~/.bash_functions
fi

# =============================================================================
#  Раздел 3: Настройка командной строки (Prompt) и автодополнения
# =============================================================================

# Добавляем функцию "вечной истории" в PROMPT_COMMAND.
# Она будет выполняться перед каждой новой командой.
[[ "$PROMPT_COMMAND" == *update_eternal_history* ]] || PROMPT_COMMAND="update_eternal_history;$PROMPT_COMMAND"

# Интеграция с Byobu и настройка стандартного PS1.
if [ -r ~/.byobu/prompt ]; then
    . ~/.byobu/prompt
    # Удаляем служебную часть, которую byobu добавляет в PS1.
    PS1=$(sed -e 's/..byobu_prompt_runtime..//' <<<"$PS1")
else
    # Установить цветной prompt (PS1), если byobu не используется.
    if [ -x /usr/bin/tput ] && tput setaf 1 >&/dev/null; then
        # Цветная версия: [user@host]:/path/to/dir$
        PS1='\[\e[32m\]\u@\h\[\e[0m\]:\[\e[34m\]\w\[\e[0m\]\$ '
    else
        # Монохромная версия для старых терминалов.
        PS1='\u@\h:\w\$ '
    fi
fi

# Включение программируемого автодополнения (bash-completion).
# Это позволяет использовать Tab для автодополнения команд и их аргументов.
if ! shopt -oq posix; then
  if [ -f /usr/share/bash-completion/bash_completion ]; then
    . /usr/share/bash-completion/bash_completion
  elif [ -f /etc/bash_completion ]; then
    . /etc/bash_completion
  fi
fi

echo "Конфигурация Bash успешно загружена."
